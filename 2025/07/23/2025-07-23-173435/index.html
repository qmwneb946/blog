<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>深入解析整洁架构：构建可维护、可测试、可扩展的软件系统 | qmwneb946 的博客</title><meta name="author" content="qmwneb946"><meta name="copyright" content="qmwneb946"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="各位技术爱好者，大家好！我是你们的老朋友 qmwneb946。 在软件开发的世界里，我们常常面临一个共同的挑战：如何构建出既能满足当前需求，又能轻松应对未来变化，并且易于测试和维护的系统？随着项目规模的扩大和业务逻辑的复杂化，软件系统往往会变得臃肿、僵硬，甚至“腐烂”。此时，一个小小的改动可能导致意想不到的连锁反应，每一次新功能的迭代都像是在雷区里跳舞。 今天，我想和大家深入探讨一个旨在解决这些痛">
<meta property="og:type" content="article">
<meta property="og:title" content="深入解析整洁架构：构建可维护、可测试、可扩展的软件系统">
<meta property="og:url" content="https://qmwneb946.dpdns.org/2025/07/23/2025-07-23-173435/index.html">
<meta property="og:site_name" content="qmwneb946 的博客">
<meta property="og:description" content="各位技术爱好者，大家好！我是你们的老朋友 qmwneb946。 在软件开发的世界里，我们常常面临一个共同的挑战：如何构建出既能满足当前需求，又能轻松应对未来变化，并且易于测试和维护的系统？随着项目规模的扩大和业务逻辑的复杂化，软件系统往往会变得臃肿、僵硬，甚至“腐烂”。此时，一个小小的改动可能导致意想不到的连锁反应，每一次新功能的迭代都像是在雷区里跳舞。 今天，我想和大家深入探讨一个旨在解决这些痛">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://qmwneb946.dpdns.org/img/icon.png">
<meta property="article:published_time" content="2025-07-23T09:34:35.000Z">
<meta property="article:modified_time" content="2025-07-26T07:24:11.198Z">
<meta property="article:author" content="qmwneb946">
<meta property="article:tag" content="科技前沿">
<meta property="article:tag" content="2025">
<meta property="article:tag" content="整洁架构（Clean Architecture）">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qmwneb946.dpdns.org/img/icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "深入解析整洁架构：构建可维护、可测试、可扩展的软件系统",
  "url": "https://qmwneb946.dpdns.org/2025/07/23/2025-07-23-173435/",
  "image": "https://qmwneb946.dpdns.org/img/icon.png",
  "datePublished": "2025-07-23T09:34:35.000Z",
  "dateModified": "2025-07-26T07:24:11.198Z",
  "author": [
    {
      "@type": "Person",
      "name": "qmwneb946",
      "url": "https://github.com/qmwneb946"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://qmwneb946.dpdns.org/2025/07/23/2025-07-23-173435/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '深入解析整洁架构：构建可维护、可测试、可扩展的软件系统',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2845632165165414" crossorigin="anonymous"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="qmwneb946 的博客" type="application/atom+xml">
</head><body><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">qmwneb946 的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">深入解析整洁架构：构建可维护、可测试、可扩展的软件系统</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">深入解析整洁架构：构建可维护、可测试、可扩展的软件系统<a class="post-edit-link" href="https://github.com/qmwneb946/blog/edit/main/source/_posts/2025-07-23-173435.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-23T09:34:35.000Z" title="发表于 2025-07-23 17:34:35">2025-07-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-26T07:24:11.198Z" title="更新于 2025-07-26 15:24:11">2025-07-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%A7%91%E6%8A%80%E5%89%8D%E6%B2%BF/">科技前沿</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><p>各位技术爱好者，大家好！我是你们的老朋友 qmwneb946。</p>
<p>在软件开发的世界里，我们常常面临一个共同的挑战：如何构建出既能满足当前需求，又能轻松应对未来变化，并且易于测试和维护的系统？随着项目规模的扩大和业务逻辑的复杂化，软件系统往往会变得臃肿、僵硬，甚至“腐烂”。此时，一个小小的改动可能导致意想不到的连锁反应，每一次新功能的迭代都像是在雷区里跳舞。</p>
<p>今天，我想和大家深入探讨一个旨在解决这些痛点的强大思想——<strong>整洁架构（Clean Architecture）</strong>。这不仅仅是一种设计模式，更是一种指导我们如何组织代码、分离关注点、管理依赖的哲学。它由享誉全球的软件大师、人称“Uncle Bob”的 Robert C. Martin 在其著作《Clean Architecture: A Craftsman’s Guide to Software Structure and Design》中提出，并迅速成为现代软件设计领域的基石之一。</p>
<p>你可能会问，我一个数学和技术博主，为何要谈架构？因为好的架构如同优美的数学公式，简洁、高效、富有普适性，它能以最小的改动成本支持最大的业务复杂度。整洁架构的核心思想，在于通过严格的依赖规则，将业务核心逻辑与外部细节（如UI、数据库、框架）彻底解耦，从而使系统具备卓越的独立性、可测试性和可维护性。这就像在数学中，我们追求抽象和泛化，使得一个定理或方法可以在不同的情境下重复使用，减少重复劳动，提升效率。</p>
<p>接下来，我将带领大家抽丝剥茧，层层深入，探索整洁架构的奥秘。</p>
<h2 id="混乱的痛点：我们为什么需要整洁架构？">混乱的痛点：我们为什么需要整洁架构？</h2>
<p>在深入了解整洁架构之前，我们先回顾一下在没有良好架构指导下，项目常常会遭遇的“七宗罪”：</p>
<ol>
<li><strong>框架锁定 (Framework Lock-in)</strong>：许多项目一开始就紧密依赖于某个Web框架（如Spring MVC, <a target="_blank" rel="noopener" href="http://ASP.NET">ASP.NET</a> Core, Django, Laravel）。一旦业务逻辑与框架API混杂在一起，未来想要更换框架几乎是不可能的任务，因为核心业务逻辑也必须随之重写。</li>
<li><strong>数据库绑定 (Database Binding)</strong>：业务逻辑直接操作数据库连接、SQL语句或ORM上下文。更换数据库类型（例如从关系型数据库到NoSQL）意味着大量的业务代码需要修改。</li>
<li><strong>UI耦合 (UI Coupling)</strong>：用户界面（例如Web前端或移动App）直接调用业务逻辑，导致业务规则与UI展示逻辑纠缠不清。UI的变化（例如从Web到桌面应用）会影响到核心业务。</li>
<li><strong>难以测试 (Difficult to Test)</strong>：由于代码高度耦合，测试一个业务逻辑单元可能需要启动整个Web服务器，连接真实的数据库，甚至依赖于特定的UI组件。这使得单元测试变得困难、缓慢且不可靠。</li>
<li><strong>难以维护 (Hard to Maintain)</strong>：当一个功能散落在代码库的各个角落，改动一处可能引发多米诺骨牌效应，导致意外的Bug。新入职的开发者需要花费大量时间来理解整个系统的运作方式。</li>
<li><strong>难以扩展 (Hard to Extend)</strong>：增加新功能或修改现有功能时，由于依赖关系错综复杂，往往需要改动大量不相关的代码，甚至可能破坏现有功能。</li>
<li><strong>业务逻辑不清晰 (Obscure Business Logic)</strong>：真正的业务规则淹没在大量的框架API调用、数据库操作和UI逻辑中，难以被清晰地识别和理解。</li>
</ol>
<p>这些问题最终导致开发效率低下，维护成本飙升，项目生命周期大大缩短。整洁架构正是为了对抗这些“软件熵增”的趋势而生。</p>
<h2 id="整洁架构的核心：依赖规则与同心圆">整洁架构的核心：依赖规则与同心圆</h2>
<p>整洁架构最标志性的特征就是那张著名的<strong>同心圆图</strong>，以及其背后所蕴含的<strong>依赖规则（Dependency Rule）</strong>。</p>
<h3 id="同心圆：层层递进的抽象">同心圆：层层递进的抽象</h3>
<p>Uncle Bob 将软件系统划分为四个主要同心圆层，从内到外分别是：</p>
<ol>
<li><strong>实体 (Entities)</strong>：<br>
这是最核心的圆，包含了企业级的业务规则。它们是纯粹的业务对象，通常是领域模型（Domain Model），不依赖于任何外部框架、数据库或UI。它们应该能够独立存在，不关心数据如何存储，也不关心数据如何呈现。例如，在一个电子商务系统中，<code>Order</code>、<code>Product</code>、<code>Customer</code> 等就是实体。</li>
<li><strong>用例 (Use Cases / Interactors)</strong>：<br>
这一层包含了应用程序特有的业务规则。它们协调实体的流动，以实现特定的业务用例（例如“创建订单”、“注册用户”）。用例层也完全独立于UI、数据库和外部框架。它们定义了系统的行为，并与实体进行交互，但并不知道数据是如何从UI传入的，也不知道数据是如何最终存储的。</li>
<li><strong>接口适配器 (Interface Adapters)</strong>：<br>
这一层负责将外部世界的数据格式转换为内部世界（用例和实体）可以理解的格式，反之亦然。它包含：
<ul>
<li><strong>控制器 (Controllers)</strong>：处理来自UI或外部系统的请求，将数据转换成用例层所需的输入格式。</li>
<li><strong>网关 (Gateways)</strong>：为用例层提供数据持久化或外部服务调用的抽象接口。例如，<code>IUserRepository</code> 接口就定义在这一层，但其具体实现（如 <code>SQLUserRepository</code>）则在更外层。</li>
<li><strong>展示器 (Presenters)</strong>：将用例层处理后的数据转换成UI可以展示的格式（例如View Model）。<br>
这一层是内外数据转换的“翻译官”，它依赖于用例层和实体层，但反过来，用例层和实体层对它一无所知。</li>
</ul>
</li>
<li><strong>框架和驱动 (Frameworks &amp; Drivers)</strong>：<br>
这是最外层的圆，包含了所有的外部工具和技术细节。例如：Web框架（Spring, Django）、数据库（MySQL, MongoDB）、UI（HTML/CSS, React, Android/iOS）、以及其他第三方库。这一层是可替换的，它实现了接口适配器层定义的接口。</li>
</ol>
<h3 id="依赖规则：内圈不能依赖外圈">依赖规则：内圈不能依赖外圈</h3>
<p>整洁架构的核心原则，也是最关键的原则，就是<strong>依赖规则</strong>：<br>
<strong>依赖关系必须永远指向内圈。内圈的代码不能依赖外圈的代码。</strong></p>
<p>这意味着：</p>
<ul>
<li>实体层不应该知道用例层、接口适配器层或框架层。</li>
<li>用例层不应该知道接口适配器层或框架层。</li>
<li>接口适配器层可以知道用例层和实体层，但不能直接知道框架层（它通过抽象接口实现）。</li>
<li>框架层可以依赖所有内层。</li>
</ul>
<p>这一规则通过**依赖倒置原则（Dependency Inversion Principle - DIP）**来实现。当内层需要与外层通信时（例如，用例层需要访问数据库），它会定义一个抽象接口（在内层），然后由外层去实现这个接口。这样，内层就只依赖于它自己定义的抽象，而不是外层的具体实现。</p>
<p>从数学角度看，我们可以将这种依赖关系想象成一个<strong>有向无环图（Directed Acyclic Graph, DAG）</strong>。每个节点是一个层，每条边表示一个依赖关系。依赖规则要求所有边都必须指向“中心”（即更抽象的层）。如果我们将系统的混乱程度看作一种<strong>熵（Entropy）</strong>，那么紧密耦合的系统具有高熵，因为局部变化会无序地扩散。整洁架构通过强制依赖方向，像一个信息过滤机制，将熵有效地限制在局部，避免其向核心业务逻辑蔓延，从而在时间维度上降低了系统熵增的速度。</p>
<p>一个简单的数学模型可以表示：<br>
假设一个系统的变更成本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> 与其耦合度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> 成正比，与内聚度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> 成反比。<br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>∝</mo><mfrac><mi>K</mi><mi>H</mi></mfrac></mrow><annotation encoding="application/x-tex">C \propto \frac{K}{H}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><br>
整洁架构通过降低 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>（减少跨层直接依赖，使用接口）和提高 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span>（将相关逻辑聚集在同一层）来优化 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>。<br>
在传统架构中， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>C</mi><mn>0</mn></msub><msup><mi>e</mi><mrow><mi>α</mi><mi>t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">C(t) = C_0 e^{\alpha t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9436em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7936em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span></span></span>，成本随时间呈指数级增长。<br>
在整洁架构中， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>C</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><msubsup><mi>C</mi><mn>0</mn><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>+</mo><mi>β</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">C&#x27;(t) = C&#x27;_0 + \beta t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.2481em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.4519em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">βt</span></span></span></span>，成本随时间呈线性增长，甚至趋于稳定，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span> 远小于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span>。这种可预测的成本模型对于长期项目至关重要。</p>
<h2 id="整洁架构的卓越优势">整洁架构的卓越优势</h2>
<p>遵循整洁架构原则会带来一系列显著的好处，使得软件系统更具弹性、生命力：</p>
<h3 id="1-独立于框架-Independent-of-Frameworks">1. 独立于框架 (Independent of Frameworks)</h3>
<p>你的核心业务逻辑不再与特定的Web框架（如Spring Boot、Django、Rails）或ORM框架（如Hibernate、SQLAlchemy）捆绑。你可以轻松地更换框架，甚至同时支持多个框架，而无需修改核心业务代码。这意味着你可以选择最适合项目需求的工具，而不是被工具所限制。</p>
<h3 id="2-独立于UI-Independent-of-UI">2. 独立于UI (Independent of UI)</h3>
<p>业务规则完全不关心数据如何呈现给用户。无论是Web应用、桌面应用、移动应用、命令行工具，甚至是API，核心业务逻辑都可以被复用。这对于需要多平台支持的产品尤为重要，也为未来的UI技术升级提供了极大的灵活性。</p>
<h3 id="3-独立于数据库-Independent-of-Database">3. 独立于数据库 (Independent of Database)</h3>
<p>你可以在不影响业务逻辑的情况下更换数据库类型（关系型、NoSQL、图数据库等）。数据持久化只是一个实现细节，由最外层负责。核心业务逻辑甚至不需要知道数据最终存储在哪里，它只通过抽象接口与数据源交互。</p>
<h3 id="4-高度可测试-Highly-Testable">4. 高度可测试 (Highly Testable)</h3>
<p>由于核心业务逻辑（实体和用例）完全独立于外部依赖，它们可以非常容易地进行单元测试。你不需要模拟复杂的Web请求、数据库连接或UI组件，只需实例化业务对象并调用其方法即可。这使得测试编写更简单、执行更快、结果更可靠，极大地提高了代码质量和开发效率。</p>
<h3 id="5-易于维护和扩展-Easy-to-Maintain-and-Extend">5. 易于维护和扩展 (Easy to Maintain and Extend)</h3>
<p>职责分离清晰，代码结构层次分明。当你需要修改或添加新功能时，通常只需要修改或添加特定层中的代码，而不会影响到其他层。这降低了引入Bug的风险，并使得新功能的开发更加迅速和安全。新人也能更快地理解系统结构，定位代码。</p>
<h3 id="6-强制业务规则中心化-Business-Rules-at-the-Center">6. 强制业务规则中心化 (Business Rules at the Center)</h3>
<p>最核心的业务规则位于架构的中心，受到最严格的保护。这确保了业务逻辑的纯粹性和清晰性，使得它不会被技术细节所污染。当开发者需要理解“系统做什么”时，他们可以直接查看用例层和实体层，而不是在大量的框架配置和基础设施代码中摸索。</p>
<p>这些优势汇聚起来，共同打造了一个“经久不衰”的软件系统。</p>
<h2 id="实践整洁架构：一个Python示例">实践整洁架构：一个Python示例</h2>
<p>理论说得再多，不如上手实践。我们将以一个简单的“用户注册”功能为例，展示如何在Python中落地整洁架构。</p>
<h3 id="项目结构概览">项目结构概览</h3>
<p>一个典型的整洁架构项目结构可能如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── domain/             # 核心业务实体和规则</span><br><span class="line">│   └── user.py</span><br><span class="line">│   └── exceptions.py</span><br><span class="line">├── application/        # 应用程序用例（业务流程）和抽象接口</span><br><span class="line">│   ├── ports/</span><br><span class="line">│   │   ├── input_ports.py  # 用例的输入接口</span><br><span class="line">│   │   └── output_ports.py # 用例的输出接口</span><br><span class="line">│   ├── use_cases/</span><br><span class="line">│   │   └── create_user.py  # 创建用户用例</span><br><span class="line">│   └── repositories/</span><br><span class="line">│       └── user_repository.py # 用户数据持久化抽象接口</span><br><span class="line">├── infrastructure/     # 接口适配器和框架实现</span><br><span class="line">│   ├── persistence/</span><br><span class="line">│   │   └── in_memory_user_repository.py # 用户数据持久化实现（例如内存）</span><br><span class="line">│   │   └── sql_user_repository.py       # 用户数据持久化实现（例如SQL）</span><br><span class="line">│   ├── web/</span><br><span class="line">│   │   └── controllers/</span><br><span class="line">│   │       └── user_controller.py      # Web API控制器</span><br><span class="line">│   │   └── presenters/</span><br><span class="line">│   │       └── user_presenter.py       # 将用例输出转换为Web响应</span><br><span class="line">│   └── cli/</span><br><span class="line">│       └── commands.py                 # 命令行接口</span><br><span class="line">└── main.py             # 应用程序入口和依赖注入</span><br></pre></td></tr></table></figure>
<h3 id="1-Domain-层：实体">1. Domain 层：实体</h3>
<p>这是我们最核心的业务逻辑。<code>User</code> 实体包含用户的基本属性和业务规则。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># domain/user.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    用户实体：定义用户核心属性和业务行为。</span></span><br><span class="line"><span class="string">    它不依赖于任何数据库、UI 或框架。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name: <span class="built_in">str</span>, email: <span class="built_in">str</span>, user_id: <span class="built_in">str</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name <span class="keyword">or</span> <span class="keyword">not</span> email:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Name and email cannot be empty.&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;@&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> email:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid email format.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.<span class="built_in">id</span> = user_id <span class="keyword">if</span> user_id <span class="keyword">else</span> <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.email = email</span><br><span class="line">        <span class="variable language_">self</span>.is_active = <span class="literal">True</span> <span class="comment"># 示例业务规则：默认活跃</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">activate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;激活用户&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.is_active = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deactivate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;禁用用户&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.is_active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;User(id=&#x27;<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>&#x27;, name=&#x27;<span class="subst">&#123;self.name&#125;</span>&#x27;, email=&#x27;<span class="subst">&#123;self.email&#125;</span>&#x27;, is_active=<span class="subst">&#123;self.is_active&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># domain/exceptions.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserAlreadyExistsError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;自定义异常：用户已存在&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserNotFoundError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;自定义异常：用户未找到&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h3 id="2-Application-层：用例和抽象接口">2. Application 层：用例和抽象接口</h3>
<p>这一层定义了应用程序的功能，以及它需要与外部交互的抽象接口。</p>
<h4 id="Input-Output-Ports">Input/Output Ports</h4>
<p>用例的输入和输出通过接口定义，这有助于解耦和测试。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application/ports/input_ports.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> NamedTuple</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义用例的请求模型，它仅仅是数据结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreateUserRequest</span>(<span class="title class_ inherited__">NamedTuple</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    email: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义用例的输入接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreateUserInputPort</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, request: CreateUserRequest</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        执行创建用户用例。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># application/ports/output_ports.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> NamedTuple</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义用例的响应模型，它仅仅是数据结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreateUserResponse</span>(<span class="title class_ inherited__">NamedTuple</span>):</span><br><span class="line">    user_id: <span class="built_in">str</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    email: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义用例的输出接口（用于通知展示层或外部系统）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreateUserOutputPort</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">present</span>(<span class="params">self, response: CreateUserResponse</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将用例执行结果呈现给输出层。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">present_error</span>(<span class="params">self, error_message: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        呈现错误信息。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h4 id="Repositories">Repositories</h4>
<p>数据持久化的抽象接口。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application/repositories/user_repository.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> domain.user <span class="keyword">import</span> User <span class="comment"># 引入内层实体</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IUserRepository</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    用户数据仓库抽象接口。</span></span><br><span class="line"><span class="string">    用例层通过此接口与数据持久化层交互，但不知道具体实现。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, user: User</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存用户。&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_email</span>(<span class="params">self, email: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[User]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据邮箱查找用户。&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_id</span>(<span class="params">self, user_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[User]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据ID查找用户。&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h4 id="Use-Cases">Use Cases</h4>
<p>用例层实现具体的业务流程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application/use_cases/create_user.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> application.ports.input_ports <span class="keyword">import</span> CreateUserRequest, CreateUserInputPort</span><br><span class="line"><span class="keyword">from</span> application.ports.output_ports <span class="keyword">import</span> CreateUserOutputPort, CreateUserResponse</span><br><span class="line"><span class="keyword">from</span> application.repositories.user_repository <span class="keyword">import</span> IUserRepository</span><br><span class="line"><span class="keyword">from</span> domain.user <span class="keyword">import</span> User <span class="comment"># 引入内层实体</span></span><br><span class="line"><span class="keyword">from</span> domain.exceptions <span class="keyword">import</span> UserAlreadyExistsError <span class="comment"># 引入内层异常</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreateUserUseCase</span>(<span class="title class_ inherited__">CreateUserInputPort</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    创建用户用例：包含创建用户的业务逻辑。</span></span><br><span class="line"><span class="string">    它依赖于 UserRepository 接口（而非具体实现），并通过 OutputPort 通知结果。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user_repository: IUserRepository, output_port: CreateUserOutputPort</span>):</span><br><span class="line">        <span class="variable language_">self</span>.user_repository = user_repository</span><br><span class="line">        <span class="variable language_">self</span>.output_port = output_port</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, request: CreateUserRequest</span>):</span><br><span class="line">        <span class="comment"># 1. 业务规则：检查用户是否已存在</span></span><br><span class="line">        existing_user = <span class="variable language_">self</span>.user_repository.find_by_email(request.email)</span><br><span class="line">        <span class="keyword">if</span> existing_user:</span><br><span class="line">            <span class="variable language_">self</span>.output_port.present_error(<span class="string">f&quot;User with email &#x27;<span class="subst">&#123;request.email&#125;</span>&#x27; already exists.&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span> UserAlreadyExistsError(<span class="string">f&quot;User with email &#x27;<span class="subst">&#123;request.email&#125;</span>&#x27; already exists.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 创建实体（核心业务逻辑）</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            new_user = User(name=request.name, email=request.email)</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.output_port.present_error(<span class="string">f&quot;Invalid user data: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="comment"># 或者重新抛出特定应用异常</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 持久化实体（通过抽象接口）</span></span><br><span class="line">        <span class="variable language_">self</span>.user_repository.save(new_user)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. 准备响应并通知输出端口</span></span><br><span class="line">        response = CreateUserResponse(</span><br><span class="line">            user_id=new_user.<span class="built_in">id</span>,</span><br><span class="line">            name=new_user.name,</span><br><span class="line">            email=new_user.email</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.output_port.present(response)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-Infrastructure-层：接口适配器和框架实现">3. Infrastructure 层：接口适配器和框架实现</h3>
<p>这一层包含数据库实现、Web框架接口等。</p>
<h4 id="Persistence-Repository-Implementation">Persistence (Repository Implementation)</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># infrastructure/persistence/in_memory_user_repository.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> application.repositories.user_repository <span class="keyword">import</span> IUserRepository</span><br><span class="line"><span class="keyword">from</span> domain.user <span class="keyword">import</span> User <span class="comment"># 引入内层实体</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InMemoryUserRepository</span>(<span class="title class_ inherited__">IUserRepository</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    内存实现的用户数据仓库。</span></span><br><span class="line"><span class="string">    用于测试或简单场景。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._users: <span class="type">Dict</span>[<span class="built_in">str</span>, User] = &#123;&#125; <span class="comment"># 以ID为键存储</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, user: User</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>._users[user.<span class="built_in">id</span>] = user</span><br><span class="line">        <span class="comment"># 也可以按邮箱索引方便查找</span></span><br><span class="line">        <span class="keyword">for</span> existing_user_id, existing_user <span class="keyword">in</span> <span class="variable language_">self</span>._users.items():</span><br><span class="line">            <span class="keyword">if</span> existing_user.email == user.email <span class="keyword">and</span> existing_user_id != user.<span class="built_in">id</span>:</span><br><span class="line">                <span class="comment"># 理论上，在UseCase层已经检查过，这里是二次保护</span></span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;Email already exists in repository.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_email</span>(<span class="params">self, email: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[User]:</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> <span class="variable language_">self</span>._users.values():</span><br><span class="line">            <span class="keyword">if</span> user.email == email:</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_id</span>(<span class="params">self, user_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[User]:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._users.get(user_id)</span><br><span class="line"></span><br><span class="line"><span class="comment"># infrastructure/persistence/sql_user_repository.py</span></span><br><span class="line"><span class="comment"># 假设我们使用SQLAlchemy作为ORM</span></span><br><span class="line"><span class="comment"># from sqlalchemy.orm import Session</span></span><br><span class="line"><span class="comment"># from application.repositories.user_repository import IUserRepository</span></span><br><span class="line"><span class="comment"># from domain.user import User</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># class SQLUserRepository(IUserRepository):</span></span><br><span class="line"><span class="comment">#     def __init__(self, session: Session):</span></span><br><span class="line"><span class="comment">#         self.session = session</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     def save(self, user: User) -&gt; None:</span></span><br><span class="line"><span class="comment">#         # 伪代码：将User实体映射到SQLAlchemy模型并保存</span></span><br><span class="line"><span class="comment">#         db_user = self.session.query(UserModel).filter_by(id=user.id).first()</span></span><br><span class="line"><span class="comment">#         if not db_user:</span></span><br><span class="line"><span class="comment">#             db_user = UserModel(id=user.id)</span></span><br><span class="line"><span class="comment">#         db_user.name = user.name</span></span><br><span class="line"><span class="comment">#         db_user.email = user.email</span></span><br><span class="line"><span class="comment">#         self.session.add(db_user)</span></span><br><span class="line"><span class="comment">#         self.session.commit()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     def find_by_email(self, email: str) -&gt; Optional[User]:</span></span><br><span class="line"><span class="comment">#         # 伪代码：从数据库查询并转换回Domain.User</span></span><br><span class="line"><span class="comment">#         db_user = self.session.query(UserModel).filter_by(email=email).first()</span></span><br><span class="line"><span class="comment">#         if db_user:</span></span><br><span class="line"><span class="comment">#             return User(name=db_user.name, email=db_user.email, user_id=db_user.id)</span></span><br><span class="line"><span class="comment">#         return None</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     def find_by_id(self, user_id: str) -&gt; Optional[User]:</span></span><br><span class="line"><span class="comment">#         # 伪代码</span></span><br><span class="line"><span class="comment">#         db_user = self.session.query(UserModel).filter_by(id=user_id).first()</span></span><br><span class="line"><span class="comment">#         if db_user:</span></span><br><span class="line"><span class="comment">#             return User(name=db_user.name, email=db_user.email, user_id=db_user.id)</span></span><br><span class="line"><span class="comment">#         return None</span></span><br></pre></td></tr></table></figure>
<h4 id="Web-Controller-and-Presenter">Web (Controller and Presenter)</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># infrastructure/web/presenters/user_presenter.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> application.ports.output_ports <span class="keyword">import</span> CreateUserOutputPort, CreateUserResponse</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreateUserWebPresenter</span>(<span class="title class_ inherited__">CreateUserOutputPort</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    创建用户用例的Web展示器。</span></span><br><span class="line"><span class="string">    将用例响应转换为Web可理解的JSON格式。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.response_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.status_code: <span class="built_in">int</span> = <span class="number">200</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">present</span>(<span class="params">self, response: CreateUserResponse</span>):</span><br><span class="line">        <span class="variable language_">self</span>.response_data = &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: response.user_id,</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: response.name,</span><br><span class="line">            <span class="string">&quot;email&quot;</span>: response.email,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;User created successfully.&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.status_code = <span class="number">201</span> <span class="comment"># Created</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">present_error</span>(<span class="params">self, error_message: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.response_data = &#123;</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: error_message</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.status_code = <span class="number">400</span> <span class="comment"># Bad Request or 409 Conflict if UserAlreadyExistsError</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># infrastructure/web/controllers/user_controller.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设使用 Flask 或 FastAPI</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify <span class="comment"># 或者 from fastapi import APIRouter, Body</span></span><br><span class="line"><span class="keyword">from</span> application.ports.input_ports <span class="keyword">import</span> CreateUserRequest, CreateUserInputPort</span><br><span class="line"><span class="keyword">from</span> infrastructure.web.presenters.user_presenter <span class="keyword">import</span> CreateUserWebPresenter</span><br><span class="line"><span class="keyword">from</span> domain.exceptions <span class="keyword">import</span> UserAlreadyExistsError</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Web控制器，处理HTTP请求并协调用例的执行。</span></span><br><span class="line"><span class="string">    它依赖于用例接口和展示器。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, create_user_use_case: CreateUserInputPort</span>):</span><br><span class="line">        <span class="variable language_">self</span>.create_user_use_case = create_user_use_case</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 1. 解析请求数据</span></span><br><span class="line">        data = request.get_json() <span class="comment"># Flask 示例</span></span><br><span class="line">        name = data.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">        email = data.get(<span class="string">&quot;email&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 准备用例请求</span></span><br><span class="line">        request_model = CreateUserRequest(name=name, email=email)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 创建展示器实例</span></span><br><span class="line">        presenter = CreateUserWebPresenter()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 4. 执行用例</span></span><br><span class="line">            <span class="comment"># 注意：用例不直接返回数据，而是通过output_port通知presenter</span></span><br><span class="line">            <span class="variable language_">self</span>.create_user_use_case.execute(request_model)</span><br><span class="line">        <span class="keyword">except</span> UserAlreadyExistsError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 用例可能抛出特定业务异常，控制器捕获并让Presenter处理错误</span></span><br><span class="line">            presenter.present_error(<span class="built_in">str</span>(e))</span><br><span class="line">            <span class="keyword">return</span> jsonify(presenter.response_data), presenter.status_code</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e: <span class="comment"># 捕获Domain层或Application层的其他校验错误</span></span><br><span class="line">            presenter.present_error(<span class="built_in">str</span>(e))</span><br><span class="line">            <span class="keyword">return</span> jsonify(presenter.response_data), presenter.status_code</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 捕获其他未预期错误</span></span><br><span class="line">            presenter.present_error(<span class="string">f&quot;An unexpected error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> jsonify(presenter.response_data), <span class="number">500</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5. 返回Web响应</span></span><br><span class="line">        <span class="keyword">return</span> jsonify(presenter.response_data), presenter.status_code</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实际的Flask应用启动</span></span><br><span class="line"><span class="comment"># app = Flask(__name__)</span></span><br><span class="line"><span class="comment"># user_repo = InMemoryUserRepository()</span></span><br><span class="line"><span class="comment"># create_user_use_case = CreateUserUseCase(user_repo, CreateUserWebPresenter()) # 这里需要优化，OutputPort应该是用例的运行时依赖</span></span><br><span class="line"><span class="comment"># user_controller = UserController(create_user_use_case)</span></span><br><span class="line"><span class="comment"># @app.route(&quot;/users&quot;, methods=[&quot;POST&quot;])</span></span><br><span class="line"><span class="comment"># def create_user_endpoint():</span></span><br><span class="line"><span class="comment">#     return user_controller.create_user()</span></span><br></pre></td></tr></table></figure>
<h3 id="4-Main-层：组合与依赖注入">4. Main 层：组合与依赖注入</h3>
<p>应用程序的入口点，负责组合所有组件并进行依赖注入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> application.use_cases.create_user <span class="keyword">import</span> CreateUserUseCase</span><br><span class="line"><span class="keyword">from</span> infrastructure.persistence.in_memory_user_repository <span class="keyword">import</span> InMemoryUserRepository</span><br><span class="line"><span class="keyword">from</span> infrastructure.web.controllers.user_controller <span class="keyword">import</span> UserController</span><br><span class="line"><span class="keyword">from</span> infrastructure.web.presenters.user_presenter <span class="keyword">import</span> CreateUserWebPresenter</span><br><span class="line"><span class="keyword">from</span> application.ports.output_ports <span class="keyword">import</span> CreateUserOutputPort <span class="comment"># 导入抽象接口</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">configure_dependencies</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    配置并返回所有组件实例。</span></span><br><span class="line"><span class="string">    这是一个手动依赖注入的示例。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    user_repository = InMemoryUserRepository() <span class="comment"># 或者替换为 SQLUserRepository(db_session)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 实例化用例时，为其提供 Repository 和 OutputPort 的实现</span></span><br><span class="line">    <span class="comment"># 注意：一个Use Case实例可以被多个Controller/Presenter复用</span></span><br><span class="line">    <span class="comment"># 但每个请求通常需要一个独立的Presenter实例来处理响应</span></span><br><span class="line">    <span class="comment"># 因此，我们通常在Controller中创建Presenter，或者通过工厂函数提供</span></span><br><span class="line">    <span class="comment"># 这里为了简化，我们在配置时传入一个OutputPort的抽象类型，实际Presenter在运行时注入</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 更好的实践是：CreateUserUseCase 构造函数只接收 Repository。</span></span><br><span class="line">    <span class="comment"># OutputPort 在 execute() 方法中通过参数传入，或者通过工厂方法创建。</span></span><br><span class="line">    <span class="comment"># 让我们调整一下 UseCase 和 Controller 的实例化逻辑，更符合Clean Architecture的推荐。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重构后的 CreateUserUseCase 初始化：</span></span><br><span class="line">    <span class="comment"># application/use_cases/create_user.py (修改 __init__ 方法)</span></span><br><span class="line">    <span class="comment"># class CreateUserUseCase(CreateUserInputPort):</span></span><br><span class="line">    <span class="comment">#     def __init__(self, user_repository: IUserRepository):</span></span><br><span class="line">    <span class="comment">#         self.user_repository = user_repository</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#     def execute(self, request: CreateUserRequest, output_port: CreateUserOutputPort):</span></span><br><span class="line">    <span class="comment">#         # ... 业务逻辑 ...</span></span><br><span class="line">    <span class="comment">#         if existing_user:</span></span><br><span class="line">    <span class="comment">#             output_port.present_error(...) # 使用传入的output_port</span></span><br><span class="line">    <span class="comment">#             raise UserAlreadyExistsError(...)</span></span><br><span class="line">    <span class="comment">#         # ...</span></span><br><span class="line">    <span class="comment">#         output_port.present(...) # 使用传入的output_port</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 那么在 main.py 中：</span></span><br><span class="line">    create_user_use_case = CreateUserUseCase(user_repository=user_repository)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Controller现在需要一个工厂或创建Presenter的逻辑</span></span><br><span class="line">    user_controller = UserController(create_user_use_case=create_user_use_case)</span><br><span class="line">    <span class="comment"># Controller内部会创建 CreateUserWebPresenter() 实例</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> user_controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>():</span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    user_controller = configure_dependencies()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.route(<span class="params"><span class="string">&quot;/users&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_user_endpoint</span>():</span><br><span class="line">        <span class="keyword">return</span> user_controller.create_user()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = create_app()</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>通过上述代码，我们可以清晰地看到不同层之间的隔离。<code>User</code> 实体只包含业务数据和规则。<code>CreateUserUseCase</code> 协调 <code>User</code> 实体和 <code>IUserRepository</code> 接口，它根本不知道数据是从哪里来的（HTTP请求还是命令行），也不知道数据存到了哪里（内存还是SQL）。<code>InMemoryUserRepository</code> 实现了 <code>IUserRepository</code> 接口，将数据存入内存，而 <code>CreateUserWebPresenter</code> 和 <code>UserController</code> 则负责将Web请求转换为用例输入，并将用例的输出转换为Web响应。</p>
<p>这种设计使得：</p>
<ul>
<li>我们可以在不改变 <code>CreateUserUseCase</code> 的情况下，将 <code>InMemoryUserRepository</code> 替换为 <code>SQLUserRepository</code>。</li>
<li>我们可以在不改变 <code>CreateUserUseCase</code> 和 <code>UserController</code> 的情况下，更换 <code>CreateUserWebPresenter</code> 来支持不同的Web框架或JSON格式。</li>
<li>我们甚至可以编写一个 <code>CreateUserCliController</code> 和 <code>CreateUserCliPresenter</code> 来提供命令行接口，而无需修改核心业务逻辑。</li>
</ul>
<h2 id="挑战与考量：世上没有银弹">挑战与考量：世上没有银弹</h2>
<p>尽管整洁架构带来了诸多好处，但它并非没有代价，也不是适用于所有项目。理解其潜在的挑战同样重要：</p>
<h3 id="1-复杂性与开销-Overhead-and-Complexity">1. 复杂性与开销 (Overhead and Complexity)</h3>
<p>对于小型、简单、生命周期短的CRUD应用，整洁架构可能会引入不必要的复杂性。大量的接口、DTO（数据传输对象）和层次结构会增加代码量，导致“样板代码”增多。这种情况下，过早的过度设计可能得不偿失。</p>
<h3 id="2-学习曲线与团队纪律-Learning-Curve-and-Team-Discipline">2. 学习曲线与团队纪律 (Learning Curve and Team Discipline)</h3>
<p>理解并正确实施整洁架构需要一定的学习曲线，特别是对于不熟悉依赖倒置、接口隔离等SOLID原则的团队成员。团队需要严格遵守依赖规则和分层约定，否则架构很快就会退化。这要求团队具备较高的软件工程素养和纪律性。</p>
<h3 id="3-数据传输的繁琐-Tedious-Data-Mapping">3. 数据传输的繁琐 (Tedious Data Mapping)</h3>
<p>由于层与层之间通过简单的数据结构（如NamedTuple、Pydantic模型或Java中的DTOs）进行通信，不同层之间可能需要频繁地进行数据映射和转换。例如，从数据库模型到领域实体，再到请求模型，再到响应模型，这会增加一些开发工作量。</p>
<h3 id="4-并非万能药-Not-a-Silver-Bullet">4. 并非万能药 (Not a Silver Bullet)</h3>
<p>整洁架构主要解决了应用级别的架构问题，它并不能解决所有软件工程问题，例如：</p>
<ul>
<li><strong>领域建模的挑战</strong>：它假设你已经很好地理解了业务领域并能设计出合理的实体。如果领域模型本身存在缺陷，整洁架构也无法拯救。</li>
<li><strong>并发和分布式系统</strong>：它不直接提供解决并发控制、分布式事务、微服务间通信等问题的方案，这些需要更高层次的架构模式（如CQRS、事件驱动架构）来补充。</li>
</ul>
<h3 id="何时采用？">何时采用？</h3>
<p>综合来看，整洁架构最适合以下场景：</p>
<ul>
<li><strong>大型或中型企业级应用</strong>：业务逻辑复杂，预期生命周期长，未来需求变化频繁。</li>
<li><strong>需要高可测试性</strong>：业务关键，对质量要求极高。</li>
<li><strong>多渠道支持</strong>：需要支持Web、移动、CLI等多种前端界面。</li>
<li><strong>团队规模较大</strong>：需要明确的职责边界来提高协作效率。</li>
<li><strong>未来可能更换技术栈</strong>：希望保持技术选择的灵活性。</li>
</ul>
<h2 id="与其他架构的关联与对比">与其他架构的关联与对比</h2>
<p>整洁架构并非孤立存在，它与许多其他流行架构思想有着千丝万缕的联系。</p>
<h3 id="1-六边形架构-Hexagonal-Architecture-Ports-and-Adapters">1. 六边形架构 (Hexagonal Architecture / Ports and Adapters)</h3>
<p>由 Alistair Cockburn 提出。六边形架构强调“端口（Ports）”和“适配器（Adapters）”的概念。应用程序核心通过“端口”（抽象接口）与外部世界（UI、数据库、外部服务）交互。“适配器”是端口的具体实现，它们适应外部技术。<br>
<strong>关联</strong>：整洁架构的“用例”层和“接口适配器”层与六边形架构的“应用核心”和“端口/适配器”概念高度吻合。可以说，整洁架构是对六边形架构和Onion架构的集大成和更细致的阐述。</p>
<h3 id="2-洋葱架构-Onion-Architecture">2. 洋葱架构 (Onion Architecture)</h3>
<p>由 Jeffrey Palermo 提出。它也采用同心圆结构，强调将领域模型放在中心，然后是领域服务、应用服务、基础设施层和UI层。其核心思想也是依赖倒置，所有依赖都指向中心。<br>
<strong>关联</strong>：洋葱架构与整洁架构在分层和依赖规则上几乎相同。它们都旨在将核心业务逻辑与技术细节分离。整洁架构可能在术语和对每个层的具体内容描述上更具普适性。</p>
<h3 id="3-领域驱动设计-Domain-Driven-Design-DDD">3. 领域驱动设计 (Domain-Driven Design - DDD)</h3>
<p>DDD 是一种软件开发方法论，旨在帮助开发人员构建复杂业务领域的软件。它强调将业务概念和业务规则转化为软件模型。<br>
<strong>关联</strong>：整洁架构为DDD提供了一个理想的物理结构。DDD中定义的“领域模型（Domain Model）”、“聚合根（Aggregate Root）”等概念可以直接对应到整洁架构的“实体（Entities）”层。DDD帮助你理解和建模业务，而整洁架构则帮助你组织这些模型，使其在技术层面保持独立和可维护。它们是绝佳的搭档。</p>
<h3 id="4-MVC-MVP-MVVM-UI-Patterns">4. MVC/MVP/MVVM (UI Patterns)</h3>
<p>这些是用户界面设计模式。</p>
<ul>
<li><strong>MVC (Model-View-Controller)</strong>: 将应用分为模型（数据和业务逻辑）、视图（用户界面）和控制器（处理用户输入）。</li>
<li><strong>MVP (Model-View-Presenter)</strong>: 改进MVC，使Presenter完全分离视图和模型。</li>
<li><strong>MVVM (Model-View-ViewModel)</strong>: 结合了数据绑定，ViewModel抽象化了视图逻辑。<br>
<strong>对比</strong>：这些模式主要关注UI层面，而整洁架构则是一种更高层次的应用架构模式。整洁架构的“接口适配器”层中的“控制器”和“展示器”可以与MVC、MVP或MVVM中的组件对应。例如，在Web应用中，<code>UserController</code> 是MVC/MVP/MVVM中的控制器/Presenter，而<code>CreateUserWebPresenter</code> 可能负责构建ViewModel供视图渲染。整洁架构确保了UI层面的技术选择不会渗透到核心业务逻辑中。</li>
</ul>
<p>这些架构思想的核心都是<strong>关注点分离（Separation of Concerns）<strong>和</strong>依赖倒置（Dependency Inversion）</strong>，它们殊途同归，共同提升软件系统的质量。</p>
<h2 id="结论：架构的艺术与工程">结论：架构的艺术与工程</h2>
<p>整洁架构不仅仅是代码组织的规定，它更是一种深思熟虑的设计哲学，它迫使我们思考软件的真正价值所在：<strong>核心业务逻辑</strong>。通过将业务核心与所有外部细节解耦，我们为系统构建了一个坚不可摧的堡垒，使其能够抵御技术变革的冲击，保持长久的生命力。</p>
<p>当然，如同任何强大的工具，它也需要熟练的掌握和明智的运用。在小型项目上过度设计是浪费，但在大型复杂项目上缺少它则是灾难。选择何时以及如何应用整洁架构，是每一位软件工程师需要不断学习和实践的艺术。</p>
<p>作为一名技术和数学的爱好者，我始终认为，软件架构与数学定理一样，追求的是简洁、优雅和普适性。整洁架构通过严格的依赖规则，降低了系统的“复杂度熵”，提升了可预测性，这与数学家追求的结构美感和逻辑严谨性不谋而合。它让我们能够将有限的精力聚焦于真正复杂的业务问题，而不是纠缠于不断变化的技术细节。</p>
<p>希望这篇长文能够帮助你对整洁架构有一个全面而深入的理解。现在，是时候将这些思想付诸实践，构建出更健壮、更灵活、更易于维护的软件系统了！</p>
<p>感谢你的阅读。如果你有任何疑问或见解，欢迎在评论区与我交流。</p>
<p>qmwneb946 敬上。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/qmwneb946">qmwneb946</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://qmwneb946.dpdns.org/2025/07/23/2025-07-23-173435/">https://qmwneb946.dpdns.org/2025/07/23/2025-07-23-173435/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://opensource.org/licenses/MIT" target="_blank">MIT License</a> 许可协议。转载请注明来源 <a href="https://qmwneb946.dpdns.org" target="_blank">qmwneb946 的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%A7%91%E6%8A%80%E5%89%8D%E6%B2%BF/">科技前沿</a><a class="post-meta__tags" href="/tags/2025/">2025</a><a class="post-meta__tags" href="/tags/%E6%95%B4%E6%B4%81%E6%9E%B6%E6%9E%84%EF%BC%88Clean-Architecture%EF%BC%89/">整洁架构（Clean Architecture）</a></div><div class="post-share"><div class="social-share" data-image="/img/icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/07/23/2025-07-23-173559/" title="分布式缓存策略：架构演进、核心机制与最佳实践"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">分布式缓存策略：架构演进、核心机制与最佳实践</div></div><div class="info-2"><div class="info-item-1">大家好，我是 qmwneb946，一名对技术与数学充满热情的博主。今天，我们将一起深入探索现代高并发系统中的核心基石之一：分布式缓存策略。在海量数据和用户请求的时代，如何高效地存取数据，降低后端负载，提供极致的用户体验，是每一个系统架构师和开发者必须面对的挑战。缓存，作为解决这一问题的利器，其重要性不言而喻。而当业务规模从单机迈向集群，从简单到复杂，分布式缓存及其精妙的策略，便成了我们驾驭海量并发的秘密武器。 这篇博客将带领大家从缓存的基础概念出发，逐步深入到分布式缓存的核心机制、各种数据分片、失效、淘汰与更新策略，并探讨其在实践中可能遇到的挑战及应对之道。我们还会穿插一些数学原理和代码示例，希望能为大家构建高性能、高可用系统提供有益的参考。 引言：为何缓存如此重要？为何需要分布式？ 在任何一个读多写少的应用场景中，数据访问的性能瓶颈往往在于存储层，无论是关系型数据库、NoSQL数据库还是文件系统，其IO速度远低于内存的访问速度。缓存的出现，正是为了弥补这种巨大的性能鸿沟。它将热点数据或计算结果临时存储在高速存储介质中（通常是内存），当后续请求再次访问这些数据时，可以直接从缓存中...</div></div></div></a><a class="pagination-related" href="/2025/07/23/2025-07-23-170622/" title="迭代加深A*（IDA*）算法：原理、实现与应用深度解析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">迭代加深A*（IDA*）算法：原理、实现与应用深度解析</div></div><div class="info-2"><div class="info-item-1">作为一名长期致力于探索算法奥秘的技术博主，我（qmwneb946）深知在计算科学的广阔天地中，搜索算法扮演着举足轻重的角色。它们是解决路径规划、人工智能游戏、优化问题乃至复杂数据结构遍历的核心工具。在众多强大的搜索算法中，A* 算法无疑是明星般的存在，以其启发式引导能力在最短路径问题上表现出色。然而，随着问题规模的爆炸式增长，A* 算法的内存消耗问题也日益凸显。 今天，我们将深入探讨一个巧妙且极具实用价值的算法——迭代加深A*（IDA*）算法。它如同一位智者，巧妙地规避了A算法的内存瓶颈，在资源受限的环境下依然能高效地找到最优解。本文将带你从基础原理出发，逐步深入IDA的内部机制、数学性质、实现细节，并剖析其优缺点及典型应用场景。准备好了吗？让我们一起踏上这场算法探索之旅！ 搜索算法的基石：A* 算法回顾与挑战 在深入IDA之前，我们有必要回顾一下它的“前辈”——A算法，并理解它所面临的挑战，这正是IDA*诞生的原因。 A* 算法概述 A* 算法是一种启发式搜索算法，广泛应用于路径查找和图遍历中。它通过结合广度优先搜索（BFS）的最优性和深度优先搜索（DFS）的效率，力求在最短时...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/07/18/2025-07-18-082408/" title="人工智能在医疗诊断中的应用：机遇与挑战"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-18</div><div class="info-item-2">人工智能在医疗诊断中的应用：机遇与挑战</div></div><div class="info-2"><div class="info-item-1">大家好，我是你们的技术和数学博主！今天，我们来深入探讨一个激动人心的领域：人工智能 (AI) 在医疗诊断中的应用。AI 的快速发展正在彻底改变医疗行业，为更精准、高效的诊断提供了前所未有的可能性。但同时，我们也需要审慎地看待其挑战和局限性。 引言：AI 赋能医疗诊断 医疗诊断是一个复杂的过程，需要医生具备丰富的知识、经验和判断力。然而，人类医生可能会受到主观偏差、疲劳以及信息过载的影响。AI 的介入，则为提高诊断准确性和效率提供了新的途径。通过分析大量的医学影像数据、病历记录和基因组信息，AI 算法可以学习识别疾病模式，辅助医生进行诊断，甚至在某些情况下独立完成初步诊断。 AI 在医疗诊断中的核心技术 深度学习在医学影像分析中的应用 深度学习，特别是卷积神经网络 (CNN)，在医学影像分析中取得了显著的成功。CNN 可以从大量的医学影像数据（例如 X 光片、CT 扫描、MRI 图像）中学习特征，并识别出细微的病变，例如肺癌结节、脑瘤或心血管疾病。 例如，一个训练良好的 CNN 模型可以比人类放射科医生更早地检测出肺癌，从而提高早期诊断率和治疗成功率。  这其中的关键在于大量的标注...</div></div></div></a><a class="pagination-related" href="/2025/07/18/2025-07-18-082643/" title="高分子化学与可降解塑料：迈向可持续未来的关键"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-18</div><div class="info-item-2">高分子化学与可降解塑料：迈向可持续未来的关键</div></div><div class="info-2"><div class="info-item-1">近年来，塑料污染已成为全球性环境问题。传统塑料由于其难以降解的特性，对环境造成了巨大的压力。而可降解塑料的出现，为解决这一问题提供了一条可行的途径。本文将深入探讨高分子化学在可降解塑料研发中的关键作用，并介绍几种主要的降解机制和材料。 高分子化学：可降解塑料的基础 可降解塑料并非简单的“可被分解的塑料”，其核心在于高分子材料的分子结构设计。高分子化学为我们提供了理解和操纵聚合物结构的工具，从而设计出具有特定降解性能的材料。传统塑料通常由难以断裂的强共价键连接而成，而可降解塑料则通过引入特定的化学键或结构单元，使其在特定条件下能够断裂，从而实现降解。  这需要对聚合物的合成方法、分子量分布、链结构以及结晶度等进行精细的控制。 常见的可降解塑料聚合物 目前，市场上常见的可降解塑料主要包括以下几种：   聚乳酸 (PLA):  PLA 是一种生物基聚合物，由可再生资源（例如玉米淀粉）制成。其降解过程主要依靠水解反应，在特定条件下（例如堆肥环境）可以被微生物降解。PLA 的机械性能较好，但耐热性相对较差。   聚羟基脂肪酸酯 (PHAs): PHAs 是一类由微生物合成的聚酯。它们具有良...</div></div></div></a><a class="pagination-related" href="/2025/07/18/2025-07-18-082805/" title="电化学储能技术的新进展：迈向更清洁、更持久的能源未来"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-18</div><div class="info-item-2">电化学储能技术的新进展：迈向更清洁、更持久的能源未来</div></div><div class="info-2"><div class="info-item-1">电化学储能技术作为解决可再生能源间歇性问题的关键技术，近年来取得了显著进展。从电动汽车到智能电网，电化学储能系统正深刻地改变着我们的生活。本文将深入探讨电化学储能技术的最新突破，涵盖不同类型的储能技术及其面临的挑战与机遇。 电化学储能技术的类型 目前，市场上主要的电化学储能技术包括： 锂离子电池 锂离子电池凭借其高能量密度、长循环寿命和相对较低的成本，占据了当前电化学储能市场的主导地位。然而，锂资源的有限性和安全性问题仍然是制约其发展的瓶颈。  近年来，研究者们致力于开发高能量密度锂离子电池，例如：  固态锂电池:  固态电解质的采用可以显著提高电池的安全性，并有望实现更高的能量密度。然而，固态电解质的离子电导率和界面接触仍然是需要克服的挑战。 锂硫电池:  锂硫电池具有极高的理论能量密度，但其循环寿命和硫的穿梭效应仍然是需要解决的关键问题。  研究者们正在探索各种改性策略来提高锂硫电池的性能。 锂空气电池:  锂空气电池拥有理论上最高的能量密度，但其反应动力学缓慢，副反应多，循环寿命短等问题限制了其商业化应用。  钠离子电池 作为锂离子的潜在替代品，钠离子电池具有成本低、资源丰...</div></div></div></a><a class="pagination-related" href="/2025/07/18/2025-07-18-092352/" title="材料科学与新型半导体材料：摩尔定律的未来"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-18</div><div class="info-item-2">材料科学与新型半导体材料：摩尔定律的未来</div></div><div class="info-2"><div class="info-item-1">引言 摩尔定律，即集成电路上的晶体管数量每隔两年翻一番，几十年来一直驱动着信息技术产业的飞速发展。然而，随着晶体管尺寸逼近物理极限，摩尔定律的持续性受到了挑战。为了维持这种指数级增长，我们需要探索新型半导体材料，突破硅基技术的瓶颈。本文将深入探讨材料科学在新型半导体材料研发中的关键作用，并介绍一些具有前景的候选材料。 新型半导体材料的需求 硅作为半导体材料的主力，其优势在于成本低、工艺成熟。但其固有的物理特性限制了其在更高频率、更高功率和更低功耗方面的性能提升。例如，硅的载流子迁移率相对较低，导致能量损耗增加，尤其是在高频应用中。因此，我们需要寻找具有更高载流子迁移率、更宽禁带宽度、更高饱和电子漂移速度等优异特性的材料。 性能瓶颈及解决方案 硅基技术的性能瓶颈主要体现在以下几个方面：  漏电流:  随着晶体管尺寸的缩小，漏电流问题日益严重，导致功耗增加和性能下降。 热耗散: 高频运行会导致晶体管产生大量热量，影响器件稳定性和可靠性。 开关速度: 硅的载流子迁移率限制了晶体管的开关速度，限制了处理器的运行频率。  为了解决这些问题，研究人员正在积极探索各种新型半导体材料，例如：  ...</div></div></div></a><a class="pagination-related" href="/2025/07/18/2025-07-18-092411/" title="弦理论中的额外维度探索：超越我们感知的宇宙"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-18</div><div class="info-item-2">弦理论中的额外维度探索：超越我们感知的宇宙</div></div><div class="info-2"><div class="info-item-1">引言 我们生活在一个看似三维的空间中，加上时间构成四维时空。然而，弦理论，这个试图统一所有基本力的优雅理论，却预言了额外维度的存在。这些额外维度并非我们日常经验所能感知，它们蜷缩在比原子尺度还要小得多的空间里。本文将深入探讨弦理论中额外维度的概念，并解释科学家们如何尝试探测这些隐藏的宇宙维度。 弦理论与额外维度：一个必要的假设 弦理论的核心思想是将基本粒子视为微小的振动弦，不同振动模式对应不同的粒子。为了使理论自洽，并消除量子场论中的一些困扰，弦理论需要引入额外空间维度。最初的弦理论版本需要 26 个维度，而超弦理论则将维度数量缩减到 10 个（或 11 个，在 M 理论中）。这多出来的 6 个（或 7 个）维度是如何隐藏起来的呢？ 卡拉比-丘空间：卷曲的维度 弦理论提出，额外维度并非不存在，而是以紧致化的形式存在，就像一根细细的管子卷曲得非常紧密，以至于在宏观尺度上无法被察觉。这些紧致化的额外维度通常被描述为卡拉比-丘空间，这是一类复杂的六维流形，具有独特的几何性质。卡拉比-丘空间的形状和大小直接影响了我们观察到的粒子物理学特性，例如粒子质量和相互作用强度。 R6R^6R6 表...</div></div></div></a><a class="pagination-related" href="/2025/07/18/2025-07-18-092451/" title="粒子物理学的标准模型之外：探索宇宙未解之谜"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-18</div><div class="info-item-2">粒子物理学的标准模型之外：探索宇宙未解之谜</div></div><div class="info-2"><div class="info-item-1">我们生活在一个由基本粒子及其相互作用组成的宇宙中。粒子物理学的标准模型，如同一个精妙的乐章，成功地描述了已知的基本粒子及其三种基本作用力（电磁力、弱力和强力），并准确预测了许多实验结果。然而，这个模型并非完美无缺，它留下了许多未解之谜，指引着我们向标准模型之外的更广阔领域探索。 标准模型的局限性 标准模型尽管取得了巨大的成功，但它并不能解释宇宙中的一切现象。一些关键的不足之处包括： 暗物质与暗能量 宇宙学观测表明，宇宙中存在大量的暗物质和暗能量，它们构成了宇宙质量能量的大部分，但标准模型中却无法解释它们的本质。暗物质不参与电磁相互作用，因此我们无法直接观测到它，只能通过其引力效应间接探测。暗能量则是一种神秘的能量形式，导致宇宙加速膨胀。它们的发现暗示着标准模型之外存在着新的物理学。 中微子质量 标准模型最初假设中微子是无质量的。然而，实验观测表明中微子具有微小的质量，这与标准模型的预言相矛盾。中微子的质量之谜需要新的物理机制来解释，例如 seesaw 机制。 质子衰变 标准模型预言质子是稳定的，然而，一些大统一理论（GUTs）预测质子会发生极其缓慢的衰变。虽然到目前为止还没有观测...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">qmwneb946</div><div class="author-info-description">一个专注于技术分享的个人博客，涵盖编程、算法、系统设计等内容</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">1342</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1346</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qmwneb946"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/qmwneb946" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:qmwneb946@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">代码与远方，技术与生活交织的篇章。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B7%E4%B9%B1%E7%9A%84%E7%97%9B%E7%82%B9%EF%BC%9A%E6%88%91%E4%BB%AC%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%95%B4%E6%B4%81%E6%9E%B6%E6%9E%84%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">混乱的痛点：我们为什么需要整洁架构？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E6%B4%81%E6%9E%B6%E6%9E%84%E7%9A%84%E6%A0%B8%E5%BF%83%EF%BC%9A%E4%BE%9D%E8%B5%96%E8%A7%84%E5%88%99%E4%B8%8E%E5%90%8C%E5%BF%83%E5%9C%86"><span class="toc-number">2.</span> <span class="toc-text">整洁架构的核心：依赖规则与同心圆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E5%BF%83%E5%9C%86%EF%BC%9A%E5%B1%82%E5%B1%82%E9%80%92%E8%BF%9B%E7%9A%84%E6%8A%BD%E8%B1%A1"><span class="toc-number">2.1.</span> <span class="toc-text">同心圆：层层递进的抽象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E8%A7%84%E5%88%99%EF%BC%9A%E5%86%85%E5%9C%88%E4%B8%8D%E8%83%BD%E4%BE%9D%E8%B5%96%E5%A4%96%E5%9C%88"><span class="toc-number">2.2.</span> <span class="toc-text">依赖规则：内圈不能依赖外圈</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E6%B4%81%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8D%93%E8%B6%8A%E4%BC%98%E5%8A%BF"><span class="toc-number">3.</span> <span class="toc-text">整洁架构的卓越优势</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%8B%AC%E7%AB%8B%E4%BA%8E%E6%A1%86%E6%9E%B6-Independent-of-Frameworks"><span class="toc-number">3.1.</span> <span class="toc-text">1. 独立于框架 (Independent of Frameworks)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%8B%AC%E7%AB%8B%E4%BA%8EUI-Independent-of-UI"><span class="toc-number">3.2.</span> <span class="toc-text">2. 独立于UI (Independent of UI)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%8B%AC%E7%AB%8B%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93-Independent-of-Database"><span class="toc-number">3.3.</span> <span class="toc-text">3. 独立于数据库 (Independent of Database)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%AB%98%E5%BA%A6%E5%8F%AF%E6%B5%8B%E8%AF%95-Highly-Testable"><span class="toc-number">3.4.</span> <span class="toc-text">4. 高度可测试 (Highly Testable)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%98%93%E4%BA%8E%E7%BB%B4%E6%8A%A4%E5%92%8C%E6%89%A9%E5%B1%95-Easy-to-Maintain-and-Extend"><span class="toc-number">3.5.</span> <span class="toc-text">5. 易于维护和扩展 (Easy to Maintain and Extend)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%BC%BA%E5%88%B6%E4%B8%9A%E5%8A%A1%E8%A7%84%E5%88%99%E4%B8%AD%E5%BF%83%E5%8C%96-Business-Rules-at-the-Center"><span class="toc-number">3.6.</span> <span class="toc-text">6. 强制业务规则中心化 (Business Rules at the Center)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5%E6%95%B4%E6%B4%81%E6%9E%B6%E6%9E%84%EF%BC%9A%E4%B8%80%E4%B8%AAPython%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.</span> <span class="toc-text">实践整洁架构：一个Python示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E6%A6%82%E8%A7%88"><span class="toc-number">4.1.</span> <span class="toc-text">项目结构概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Domain-%E5%B1%82%EF%BC%9A%E5%AE%9E%E4%BD%93"><span class="toc-number">4.2.</span> <span class="toc-text">1. Domain 层：实体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Application-%E5%B1%82%EF%BC%9A%E7%94%A8%E4%BE%8B%E5%92%8C%E6%8A%BD%E8%B1%A1%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.3.</span> <span class="toc-text">2. Application 层：用例和抽象接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Input-Output-Ports"><span class="toc-number">4.3.1.</span> <span class="toc-text">Input&#x2F;Output Ports</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Repositories"><span class="toc-number">4.3.2.</span> <span class="toc-text">Repositories</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Use-Cases"><span class="toc-number">4.3.3.</span> <span class="toc-text">Use Cases</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Infrastructure-%E5%B1%82%EF%BC%9A%E6%8E%A5%E5%8F%A3%E9%80%82%E9%85%8D%E5%99%A8%E5%92%8C%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.4.</span> <span class="toc-text">3. Infrastructure 层：接口适配器和框架实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Persistence-Repository-Implementation"><span class="toc-number">4.4.1.</span> <span class="toc-text">Persistence (Repository Implementation)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Web-Controller-and-Presenter"><span class="toc-number">4.4.2.</span> <span class="toc-text">Web (Controller and Presenter)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Main-%E5%B1%82%EF%BC%9A%E7%BB%84%E5%90%88%E4%B8%8E%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-number">4.5.</span> <span class="toc-text">4. Main 层：组合与依赖注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%91%E6%88%98%E4%B8%8E%E8%80%83%E9%87%8F%EF%BC%9A%E4%B8%96%E4%B8%8A%E6%B2%A1%E6%9C%89%E9%93%B6%E5%BC%B9"><span class="toc-number">5.</span> <span class="toc-text">挑战与考量：世上没有银弹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E5%BC%80%E9%94%80-Overhead-and-Complexity"><span class="toc-number">5.1.</span> <span class="toc-text">1. 复杂性与开销 (Overhead and Complexity)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AD%A6%E4%B9%A0%E6%9B%B2%E7%BA%BF%E4%B8%8E%E5%9B%A2%E9%98%9F%E7%BA%AA%E5%BE%8B-Learning-Curve-and-Team-Discipline"><span class="toc-number">5.2.</span> <span class="toc-text">2. 学习曲线与团队纪律 (Learning Curve and Team Discipline)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E7%9A%84%E7%B9%81%E7%90%90-Tedious-Data-Mapping"><span class="toc-number">5.3.</span> <span class="toc-text">3. 数据传输的繁琐 (Tedious Data Mapping)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%B9%B6%E9%9D%9E%E4%B8%87%E8%83%BD%E8%8D%AF-Not-a-Silver-Bullet"><span class="toc-number">5.4.</span> <span class="toc-text">4. 并非万能药 (Not a Silver Bullet)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E9%87%87%E7%94%A8%EF%BC%9F"><span class="toc-number">5.5.</span> <span class="toc-text">何时采用？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%9E%B6%E6%9E%84%E7%9A%84%E5%85%B3%E8%81%94%E4%B8%8E%E5%AF%B9%E6%AF%94"><span class="toc-number">6.</span> <span class="toc-text">与其他架构的关联与对比</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%AD%E8%BE%B9%E5%BD%A2%E6%9E%B6%E6%9E%84-Hexagonal-Architecture-Ports-and-Adapters"><span class="toc-number">6.1.</span> <span class="toc-text">1. 六边形架构 (Hexagonal Architecture &#x2F; Ports and Adapters)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B4%8B%E8%91%B1%E6%9E%B6%E6%9E%84-Onion-Architecture"><span class="toc-number">6.2.</span> <span class="toc-text">2. 洋葱架构 (Onion Architecture)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1-Domain-Driven-Design-DDD"><span class="toc-number">6.3.</span> <span class="toc-text">3. 领域驱动设计 (Domain-Driven Design - DDD)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-MVC-MVP-MVVM-UI-Patterns"><span class="toc-number">6.4.</span> <span class="toc-text">4. MVC&#x2F;MVP&#x2F;MVVM (UI Patterns)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA%EF%BC%9A%E6%9E%B6%E6%9E%84%E7%9A%84%E8%89%BA%E6%9C%AF%E4%B8%8E%E5%B7%A5%E7%A8%8B"><span class="toc-number">7.</span> <span class="toc-text">结论：架构的艺术与工程</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/26/hello-world/" title="Hello World">Hello World</a><time datetime="2025-07-26T07:24:11.314Z" title="发表于 2025-07-26 15:24:11">2025-07-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/26/%E5%8D%9A%E5%BC%88%E8%AE%BA%E5%9F%BA%E7%A1%80/" title="博弈论基础">博弈论基础</a><time datetime="2025-07-26T07:24:11.314Z" title="发表于 2025-07-26 15:24:11">2025-07-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/25/2025-07-26-072114/" title="二维材料的拓扑相变：从咖啡杯到量子计算的跃迁">二维材料的拓扑相变：从咖啡杯到量子计算的跃迁</a><time datetime="2025-07-25T23:21:14.000Z" title="发表于 2025-07-26 07:21:14">2025-07-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/25/2025-07-26-071957/" title="揭秘标准模型中的味物理：通向新世界的大门">揭秘标准模型中的味物理：通向新世界的大门</a><time datetime="2025-07-25T23:19:57.000Z" title="发表于 2025-07-26 07:19:57">2025-07-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/25/2025-07-26-071845/" title="宇宙深空的守护者：系外行星磁场探测的奥秘与前沿">宇宙深空的守护者：系外行星磁场探测的奥秘与前沿</a><time datetime="2025-07-25T23:18:45.000Z" title="发表于 2025-07-26 07:18:45">2025-07-26</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By qmwneb946</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css')
    if (true) {
      await btf.getScript('https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'qmwneb946/blog',
      'data-repo-id': 'R_kgDOPM6cWw',
      'data-category-id': 'DIC_kwDOPM6cW84CtEzo',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>